# 影響マップ (Influence Map)

音楽アーティスト間の影響関係を可視化するインタラクティブなネットワークグラフアプリケーション。

**本番URL**: https://tree-jade.vercel.app
**リポジトリ**: https://github.com/chikimall3/influence-map

---

## 1. プロジェクトの概要

「影響マップ」は、音楽アーティスト同士の影響関係（誰が誰に影響を与えたか）をネットワークグラフとして視覚的に探索できるWebアプリケーションである。

Wikidata（P737: influenced by）と COMAP/AllMusic（ICM 2021 Problem D）の2つのデータソースを統合し、**7,150人のアーティスト**と**44,063件の影響関係**を収録。ユーザーはアーティストを検索・選択し、その影響ネットワークをグラフ上でインタラクティブに探索できる。

### ターゲットユーザー
- 音楽の系譜やジャンルの関連性に興味がある音楽ファン
- 新しいアーティストを影響関係から発見したいリスナー
- 音楽史の影響ネットワークを研究する学生・研究者

---

## 2. 主な機能とページ構成

### ページ構成

| パス | ページ | 説明 |
|------|--------|------|
| `/` | ホーム | 検索バー + 人気アーティスト12件のカードグリッド |
| `/artist/:id` | エクスプローラー | グラフ可視化 + アーティスト詳細パネル |

### 主要機能

#### セマンティックズーム（SZ）
ノードをタップすると SZ モードに入り、影響元（上段）と影響先（下段）が中心から左右に広がるツリー型レイアウトで表示される。マウスホイールで表示ノード数を1件単位で増減でき、フィルターレベルはノードごとに記憶される。背景タップで SZ を解除してもフィルター結果はマップ上に保持される。

#### 経路探索
2つのアーティスト間の最短接続経路を A* アルゴリズムで探索。経路上のノードとエッジが金色でハイライトされ、他はディムアウトする。

#### 影響タイプフィルター
影響関係を5タイプ（音楽的・歌詞的・思想的・美学的・人的）で色分けし、レジェンドクリックで個別フィルタリングが可能。

#### リアルタイム検索
Supabase の trigram インデックスを活用し、日本語・英語名で部分一致検索（300ms デバウンス）。

#### その他
- **ツールチップ**: ノードホバーで名前・ジャンル・生年表示
- **共有**: URL コピー機能（トースト通知付き）
- **オンボーディング**: 初回訪問時に操作ガイドオーバーレイ表示
- **接続数制限**: 方向あたり最大15件をDB側で制限し、情報過多を防止

---

## 3. 使用技術と開発環境

### フロントエンド
| 技術 | バージョン | 用途 |
|------|-----------|------|
| React | 19.2 | UIフレームワーク |
| Vite | 7.3 | ビルドツール・開発サーバー |
| React Router | 7.13 | クライアントサイドルーティング |
| Cytoscape.js | 3.33 | グラフ可視化エンジン |
| cytoscape-dagre | 2.5 | 階層型レイアウトアルゴリズム |
| i18next | 25.8 | 国際化（現在は日本語のみ） |

### バックエンド
| 技術 | 用途 |
|------|------|
| Supabase | PostgreSQL データベース + REST API + RLS |
| Vercel | ホスティング・CI/CD（main ブランチへのpushで自動デプロイ） |
| Vercel Analytics | アクセス解析 |

### テスト・開発
| 技術 | 用途 |
|------|------|
| Vitest | ユニットテスト（キャッシュ、フィルター関数） |
| Puppeteer | E2E テスト・スクリーンショット検証 |
| ESLint | コード品質管理 |

### データソース
| ソース | 件数 | 説明 |
|--------|------|------|
| Wikidata (P737) | ~1,600 アーティスト / ~2,000 関係 | セルフステートメント + 学術情報源 |
| COMAP/AllMusic | ~5,500 アーティスト / ~42,000 関係 | 専門家データベース (ICM 2021) |
| **合計** | **7,150 アーティスト / 44,063 関係** | |

---

## 4. UI/UX 設計と設計意図

### デザインシステム
**Ink & Paper パレット** — 暗色系の落ち着いた色調で、グラフのノードとエッジが視覚的に映える設計。

```
背景:   #121210 (ink-black) → #1c1c1a (charcoal) → #2a2a26 (lighter)
テキスト: #e8e4d9 (paper-texture) → #8a8880 (paper-muted)
アクセント: #7da38d (sage/緑) / #d4a753 (ochre/金) / #c25e5e (clay/赤)
```

### タイポグラフィ
- **本文**: Noto Sans JP（日本語対応ゴシック体）
- **見出し**: Playfair Display（セリフ体、格調ある印象）

### 設計意図

1. **探索重視のUX**: ホーム→グラフの2ステップで即座に探索開始できるシンプルな導線。グラフ上でノードをタップするだけで関連アーティストが展開される。

2. **セマンティックズームの3層設計**:
   - **影響元は常に全表示**: 「誰に影響を受けたか」は文脈として重要なため、フィルター対象外
   - **影響先はフィルタリング可能**: 1件〜50件まで段階的に絞り込み
   - **中心から外側に広がるレイアウト**: 重要度が高いノードが中心に位置し、フィルター時に外側から消えていく

3. **情報過多の防止**: 7,000以上のアーティストを扱うが、1回のロードで表示するのは方向あたり最大15件に制限。セマンティックズームでさらに絞り込める。

4. **状態の記憶**: ノードごとにフィルターレベルを保存し、再選択時に前回の状態から再開。SZ解除後もフィルター結果を地図上に保持。

5. **ダークUIの採用**: グラフの線とノードが暗い背景上で明瞭に視認でき、長時間の探索でも目の疲労を軽減。

### レスポンシブ対応
- **デスクトップ**: グラフ（左）+ 詳細パネル（右）の2カラム構成
- **モバイル (768px以下)**: グラフ上 + パネル下のスタック構成。カード2列グリッド。

---

## 5. 構成とディレクトリ設計

```
tree/
├── public/                    # 静的ファイル
│   ├── favicon.svg
│   └── themes.html
├── src/
│   ├── App.jsx                # ルーティング定義
│   ├── App.css
│   ├── main.jsx               # エントリーポイント
│   ├── index.css              # グローバルCSS変数・リセット
│   ├── pages/
│   │   ├── Home.jsx           # ホーム画面（検索 + 人気アーティスト）
│   │   ├── Home.css
│   │   └── Explorer.jsx       # グラフ探索画面（オンボーディング付き）
│   ├── components/
│   │   ├── SearchBar/         # 検索バー（リアルタイム部分一致）
│   │   ├── GraphView/         # グラフ可視化（770行、最大コンポーネント）
│   │   └── ArtistPanel/       # アーティスト詳細パネル
│   ├── lib/
│   │   ├── supabase.js        # Supabase クライアント初期化
│   │   └── cache.js           # インメモリキャッシュ（5分TTL）
│   ├── utils/
│   │   └── graph-utils.js     # フィルターレベル→表示数変換
│   └── i18n/
│       ├── config.js          # i18next設定
│       └── locales/ja.json    # 日本語翻訳（50キー）
├── supabase/
│   ├── schema.sql             # DB定義（3テーブル + RLS + インデックス）
│   └── get_popular_artists.sql
├── scripts/
│   ├── fetch-wikidata.js      # Wikidata SPARQL取得
│   ├── import-to-supabase.js  # Wikidataインポート
│   ├── import-comap.js        # COMAPデータセットインポート
│   ├── fetch-images.js        # Wikimedia Commons画像取得
│   └── test-*.mjs             # Puppeteer E2Eテスト群
├── data/
│   └── influence_data.csv     # COMAPデータ（42,770行）
├── vercel.json                # SPAリライトルール
├── vite.config.js             # ビルド設定（チャンク分割）
└── package.json
```

### コード規模
| 区分 | 行数 |
|------|------|
| JavaScript/JSX | ~2,300行 |
| CSS | ~1,260行 |
| SQL (スキーマ) | ~100行 |
| スクリプト (インポート・テスト) | ~1,500行 |
| **合計** | **~5,160行** |

---

## 6. 現状の課題点

### データ品質
- **日本語名の欠落**: COMAPデータの5,500アーティストには日本語名がない（Wikidataソースの1,600人のみ）
- **画像の欠落**: COMAP由来アーティストにはプロフィール画像がない
- **ジャンルの粗さ**: COMAPのジャンルは "Pop/Rock" のような大分類のみで、細分類がない
- **影響タイプの単一性**: COMAP由来の影響関係は全て `musical` タイプ（AllMusicに種別情報がないため）

### パフォーマンス
- **大量接続ノードの初回レイアウト**: 31ノード（15+15+ルート）のdagreレイアウト計算にわずかな遅延がある
- **キャッシュがセッション限定**: ページリロードでキャッシュが消える（永続化なし）

### 機能的制限
- **接続上位15件のみ表示**: より多くの接続を見る手段がない（「もっと見る」ボタン未実装）
- **検索が名前のみ**: ジャンルや年代での検索・フィルタリングができない
- **言語が日本語のみ**: UIは日本語固定（i18n基盤は整備済みだが英語翻訳なし）
- **ソース引用が未充実**: `sources` テーブルはスキーマ定義済みだがデータ投入されていない

---

## 7. 将来的な拡張計画・展望

### 短期（データ拡充）
- **日本語名の補完**: COMAP由来アーティストにWikidata / Wikipedia APIで日本語名を付与
- **画像の補完**: Spotify API / Wikimedia Commonsからプロフィール画像を取得
- **「もっと読み込む」機能**: 15件制限を超える接続を段階的にロードするUI

### 中期（機能拡張）
- **高度な検索**: ジャンル・年代・国でフィルタリングできる検索機能
- **タイムライン表示**: 年代別に影響関係の変遷を視覚化
- **クラスタリング表示**: ジャンルや時代ごとにノードを自動グルーピング
- **英語UIの追加**: 既存のi18n基盤に英語翻訳を追加
- **ソース引用の充実**: 影響関係の根拠（インタビュー記事、学術論文等）を表示

### 長期（プラットフォーム発展）
- **ユーザー投稿型データ**: コミュニティからの影響関係の提案・投票システム（trust_level='community'）
- **Spotify連携**: ユーザーの視聴履歴から影響ネットワーク上のレコメンデーション
- **楽曲特徴量の可視化**: COMAPの`full_music_data.csv`（98,000曲のSpotify特徴量）を活用し、影響関係を音楽的類似性で裏付け
- **API公開**: 影響関係データのパブリックAPI提供
- **PWA化**: オフライン対応、ホーム画面追加
